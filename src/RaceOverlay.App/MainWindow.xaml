<Window x:Class="RaceOverlay.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:RaceOverlay.App"
        xmlns:validation="clr-namespace:RaceOverlay.App.Validation"
        mc:Ignorable="d"
        Title="RaceOverlay - Widget Manager"
        AutomationProperties.AutomationId="MainWindow"
        Height="650"
        Width="1100"
        WindowState="Maximized"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource RO.BackgroundBrush}">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <Style x:Key="SettingsCheckBox" TargetType="CheckBox">
            <Setter Property="Foreground" Value="{StaticResource RO.ForegroundBrush}"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Margin" Value="0,4"/>
        </Style>
        <Style x:Key="SettingsLabel" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource RO.MutedBrush}"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Margin" Value="0,4,8,4"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="SettingsTextBox" TargetType="TextBox">
            <Setter Property="Background" Value="{StaticResource RO.SurfaceBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource RO.ForegroundBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource RO.BorderBrush}"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="Width" Value="60"/>
            <Setter Property="Margin" Value="0,4"/>
            <Setter Property="Validation.ErrorTemplate">
                <Setter.Value>
                    <ControlTemplate>
                        <Border BorderBrush="{StaticResource RO.RedBrush}" BorderThickness="1.5" CornerRadius="2" Margin="-1">
                            <AdornedElementPlaceholder/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="Validation.HasError" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource RO.RedBrush}"/>
                    <Setter Property="ToolTip" Value="{Binding RelativeSource={RelativeSource Self}, Path=(Validation.Errors)[0].ErrorContent}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Main Content: 3 Columns -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="200"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="250"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Widget Library -->
            <Border Grid.Column="0" Background="{StaticResource RO.SurfaceBrush}"
                    BorderBrush="{StaticResource RO.BorderBrush}" BorderThickness="0,0,1,0">
                <DockPanel LastChildFill="True">
                    <TextBlock DockPanel.Dock="Top" Text="Widget Library"
                               FontSize="13" FontWeight="Bold"
                               Foreground="{StaticResource RO.ForegroundBrush}"
                               Margin="12,12,12,8"/>
                    <ItemsControl ItemsSource="{Binding WidgetLibraryItems}"
                                  AutomationProperties.AutomationId="WidgetLibraryList">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="12,6" Background="Transparent">
                                    <DockPanel>
                                        <ToggleButton DockPanel.Dock="Right"
                                                      IsChecked="{Binding IsEnabled, Mode=TwoWay}"
                                                      Style="{StaticResource ToggleSwitchStyle}"
                                                      VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding DisplayName}"
                                                   Foreground="{StaticResource RO.ForegroundBrush}"
                                                   FontSize="12"
                                                   VerticalAlignment="Center"/>
                                    </DockPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </DockPanel>
            </Border>

            <!-- Center Panel: Active Widgets -->
            <DockPanel Grid.Column="1" LastChildFill="True" Margin="16,12">
                <TextBlock DockPanel.Dock="Top" Text="Active Widgets"
                           FontSize="13" FontWeight="Bold"
                           Foreground="{StaticResource RO.ForegroundBrush}"
                           Margin="0,0,0,12"/>

                <!-- Empty state -->
                <TextBlock DockPanel.Dock="Top"
                           Text="Toggle widgets on from the library to activate them"
                           Foreground="{StaticResource RO.MutedBrush}"
                           FontSize="12" FontStyle="Italic" Margin="0,8,0,0"
                           Visibility="{Binding ActiveWidgetCards.Count, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>

                <!-- Card grid -->
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding ActiveWidgetCards}"
                                  AutomationProperties.AutomationId="ActiveWidgetCards">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Style="{StaticResource WidgetCardStyle}"
                                        Content="{Binding DisplayName}"
                                        AutomationProperties.AutomationId="{Binding WidgetId}"
                                        Command="{Binding DataContext.SelectActiveCardCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="CardBorder" CornerRadius="8"
                                                    Background="{StaticResource RO.SurfaceBrush}"
                                                    BorderBrush="{StaticResource RO.BorderBrush}"
                                                    BorderThickness="1" Padding="8"
                                                    Width="110" Height="100">
                                                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                    <Path Fill="{StaticResource RO.MutedBrush}"
                                                          Stretch="Uniform" Width="28" Height="28"
                                                          HorizontalAlignment="Center" Margin="0,0,0,8"
                                                          Data="{Binding IconKey, Converter={x:Null}}"/>
                                                    <TextBlock Text="{Binding DisplayName}"
                                                               Foreground="{StaticResource RO.ForegroundBrush}"
                                                               FontSize="11" TextAlignment="Center"
                                                               HorizontalAlignment="Center"/>
                                                </StackPanel>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="CardBorder" Property="BorderBrush" Value="{StaticResource RO.PurpleBrush}"/>
                                                    <Setter TargetName="CardBorder" Property="Background" Value="{StaticResource RO.SurfaceLightBrush}"/>
                                                </Trigger>
                                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                    <Setter TargetName="CardBorder" Property="BorderBrush" Value="{StaticResource RO.PurpleBrush}"/>
                                                    <Setter TargetName="CardBorder" Property="BorderThickness" Value="2"/>
                                                </DataTrigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </DockPanel>

            <!-- Right Panel: Configuration -->
            <Border Grid.Column="2" Background="{StaticResource RO.SurfaceBrush}"
                    BorderBrush="{StaticResource RO.BorderBrush}" BorderThickness="1,0,0,0">
                <DockPanel LastChildFill="True">
                    <TextBlock DockPanel.Dock="Top" Text="Configuration"
                               FontSize="13" FontWeight="Bold"
                               Foreground="{StaticResource RO.ForegroundBrush}"
                               Margin="12,12,12,8"/>

                    <!-- No widget selected message -->
                    <TextBlock DockPanel.Dock="Top"
                               Text="Select an active widget to configure"
                               Foreground="{StaticResource RO.MutedBrush}"
                               FontSize="12" FontStyle="Italic" Margin="12,8,12,0"
                               Visibility="{Binding IsActiveWidgetSelected, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>

                    <!-- Settings panel (visible when widget selected) -->
                    <Border Background="Transparent" Margin="12,4"
                            Visibility="{Binding IsActiveWidgetSelected, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <!-- Relative Overlay Settings -->
                                <StackPanel>
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedConfigWidgetId}" Value="relative-overlay">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>

                                    <TextBlock Text="COLUMNS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,0,0,8"/>
                                    <CheckBox Content="Position" IsChecked="{Binding ShowPosition}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Class Color" IsChecked="{Binding ShowClassColor}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Driver Name" IsChecked="{Binding ShowDriverName}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Rating" IsChecked="{Binding ShowRating}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Stint" IsChecked="{Binding ShowStint}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Lap Time" IsChecked="{Binding ShowLapTime}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Gap" IsChecked="{Binding ShowGap}" Style="{StaticResource SettingsCheckBox}"/>

                                    <TextBlock Text="DATA" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Drivers Ahead" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="DriversAhead" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="1" Max="30"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Drivers Behind" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="DriversBehind" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="1" Max="30"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Update Interval (ms)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="UpdateIntervalMs" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="10" Max="10000"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>
                                </StackPanel>

                                <!-- Fuel Calculator Settings -->
                                <StackPanel>
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedConfigWidgetId}" Value="fuel-calculator">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>

                                    <TextBlock Text="FUEL SETTINGS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,0,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Tank Capacity (L)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="FuelTankCapacity" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:DoubleRangeValidationRule Min="0.1" Max="999"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>
                                </StackPanel>

                                <!-- Inputs Settings -->
                                <StackPanel>
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedConfigWidgetId}" Value="inputs">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>

                                    <TextBlock Text="INPUTS SETTINGS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,0,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Update Interval (ms)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="InputsUpdateIntervalMs" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="10" Max="10000"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <TextBlock Text="COLORS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Throttle" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}" Width="80">
                                            <TextBox.Text>
                                                <Binding Path="InputsThrottleColor" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:HexColorValidationRule/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Brake" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}" Width="80">
                                            <TextBox.Text>
                                                <Binding Path="InputsBrakeColor" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:HexColorValidationRule/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Clutch" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}" Width="80">
                                            <TextBox.Text>
                                                <Binding Path="InputsClutchColor" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:HexColorValidationRule/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <TextBlock Text="VISIBILITY" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>

                                    <CheckBox Content="Show Clutch" IsChecked="{Binding InputsShowClutch}" Style="{StaticResource SettingsCheckBox}"/>
                                </StackPanel>

                                <!-- Standings Settings -->
                                <StackPanel>
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedConfigWidgetId}" Value="standings">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>

                                    <TextBlock Text="STANDINGS SETTINGS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,0,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Update Interval (ms)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="StandingsUpdateIntervalMs" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="10" Max="10000"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Max Drivers" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="StandingsMaxDrivers" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="1" Max="60"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <TextBlock Text="COLUMNS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>

                                    <CheckBox Content="Class Color" IsChecked="{Binding StandingsShowClassColor}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Car Number" IsChecked="{Binding StandingsShowCarNumber}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Positions Gained" IsChecked="{Binding StandingsShowPositionsGained}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="License" IsChecked="{Binding StandingsShowLicense}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="iRating" IsChecked="{Binding StandingsShowIRating}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Car Brand" IsChecked="{Binding StandingsShowCarBrand}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Interval" IsChecked="{Binding StandingsShowInterval}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Gap" IsChecked="{Binding StandingsShowGap}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Last Lap Time" IsChecked="{Binding StandingsShowLastLapTime}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Delta" IsChecked="{Binding StandingsShowDelta}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Pit Status" IsChecked="{Binding StandingsShowPitStatus}" Style="{StaticResource SettingsCheckBox}"/>
                                </StackPanel>

                                <!-- Lap Timer Settings -->
                                <StackPanel>
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedConfigWidgetId}" Value="lap-timer">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>

                                    <TextBlock Text="LAP TIMER SETTINGS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,0,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Update Interval (ms)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="LapTimerUpdateIntervalMs" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="10" Max="10000"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <TextBlock Text="VISIBILITY" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>

                                    <CheckBox Content="Show Delta to Best" IsChecked="{Binding LapTimerShowDeltaToBest}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Show Last Lap" IsChecked="{Binding LapTimerShowLastLap}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Show Best Lap" IsChecked="{Binding LapTimerShowBestLap}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Show Delta Last vs Best" IsChecked="{Binding LapTimerShowDeltaLastBest}" Style="{StaticResource SettingsCheckBox}"/>
                                </StackPanel>

                                <!-- Track Map Settings -->
                                <StackPanel>
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedConfigWidgetId}" Value="track-map">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>

                                    <TextBlock Text="TRACK MAP SETTINGS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,0,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Update Interval (ms)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="TrackMapUpdateIntervalMs" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="10" Max="10000"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <TextBlock Text="VISIBILITY" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>

                                    <CheckBox Content="Show Driver Names" IsChecked="{Binding TrackMapShowDriverNames}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Show Pit Status" IsChecked="{Binding TrackMapShowPitStatus}" Style="{StaticResource SettingsCheckBox}"/>
                                </StackPanel>

                                <!-- Weather Settings -->
                                <StackPanel>
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedConfigWidgetId}" Value="weather">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>

                                    <TextBlock Text="WEATHER SETTINGS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,0,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Update Interval (ms)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="WeatherUpdateIntervalMs" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="10" Max="10000"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <TextBlock Text="VISIBILITY" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>

                                    <CheckBox Content="Show Wind" IsChecked="{Binding WeatherShowWind}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Show Forecast" IsChecked="{Binding WeatherShowForecast}" Style="{StaticResource SettingsCheckBox}"/>
                                </StackPanel>

                                <!-- Input Trace Settings -->
                                <StackPanel>
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedConfigWidgetId}" Value="input-trace">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>

                                    <TextBlock Text="INPUT TRACE SETTINGS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,0,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Update Interval (ms)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="InputTraceUpdateIntervalMs" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="10" Max="10000"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="History (seconds)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="InputTraceHistorySeconds" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="1" Max="60"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <TextBlock Text="COLORS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Throttle" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}" Width="80">
                                            <TextBox.Text>
                                                <Binding Path="InputTraceThrottleColor" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:HexColorValidationRule/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Brake" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}" Width="80">
                                            <TextBox.Text>
                                                <Binding Path="InputTraceBrakeColor" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:HexColorValidationRule/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>
                                </StackPanel>

                                <!-- Radar Settings -->
                                <StackPanel>
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedConfigWidgetId}" Value="radar">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>

                                    <TextBlock Text="GENERAL" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,0,0,8"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Range (meters)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="RadarRangeMeters" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:DoubleRangeValidationRule Min="5" Max="200"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Update Interval (ms)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="RadarUpdateIntervalMs" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="10" Max="10000"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <CheckBox Content="Use Mock Data" IsChecked="{Binding RadarUseMockData}" Style="{StaticResource SettingsCheckBox}"/>

                                    <TextBlock Text="COLORS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>

                                    <CheckBox Content="Use Proximity Colors" IsChecked="{Binding RadarUseProximityColors}" Style="{StaticResource SettingsCheckBox}"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Player" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}" Width="80">
                                            <TextBox.Text>
                                                <Binding Path="RadarPlayerColor" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:HexColorValidationRule/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <!-- Opponent color (shown when proximity colors OFF) -->
                                    <StackPanel Orientation="Horizontal" Visibility="{Binding RadarUseProximityColors, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                        <TextBlock Text="Opponent" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}" Width="80">
                                            <TextBox.Text>
                                                <Binding Path="RadarOpponentColor" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:HexColorValidationRule/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>

                                    <!-- Proximity color settings (shown when proximity colors ON) -->
                                    <StackPanel Visibility="{Binding RadarUseProximityColors, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Far Color" Style="{StaticResource SettingsLabel}"/>
                                            <TextBox Style="{StaticResource SettingsTextBox}" Width="80">
                                                <TextBox.Text>
                                                    <Binding Path="RadarProximityFarColor" UpdateSourceTrigger="PropertyChanged">
                                                        <Binding.ValidationRules>
                                                            <validation:HexColorValidationRule/>
                                                        </Binding.ValidationRules>
                                                    </Binding>
                                                </TextBox.Text>
                                            </TextBox>
                                        </StackPanel>

                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Mid Color" Style="{StaticResource SettingsLabel}"/>
                                            <TextBox Style="{StaticResource SettingsTextBox}" Width="80">
                                                <TextBox.Text>
                                                    <Binding Path="RadarProximityMidColor" UpdateSourceTrigger="PropertyChanged">
                                                        <Binding.ValidationRules>
                                                            <validation:HexColorValidationRule/>
                                                        </Binding.ValidationRules>
                                                    </Binding>
                                                </TextBox.Text>
                                            </TextBox>
                                        </StackPanel>

                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Close Color" Style="{StaticResource SettingsLabel}"/>
                                            <TextBox Style="{StaticResource SettingsTextBox}" Width="80">
                                                <TextBox.Text>
                                                    <Binding Path="RadarProximityCloseColor" UpdateSourceTrigger="PropertyChanged">
                                                        <Binding.ValidationRules>
                                                            <validation:HexColorValidationRule/>
                                                        </Binding.ValidationRules>
                                                    </Binding>
                                                </TextBox.Text>
                                            </TextBox>
                                        </StackPanel>

                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Close Threshold (m)" Style="{StaticResource SettingsLabel}"/>
                                            <TextBox Style="{StaticResource SettingsTextBox}">
                                                <TextBox.Text>
                                                    <Binding Path="RadarProximityCloseThreshold" UpdateSourceTrigger="PropertyChanged">
                                                        <Binding.ValidationRules>
                                                            <validation:DoubleRangeValidationRule Min="1" Max="100"/>
                                                        </Binding.ValidationRules>
                                                    </Binding>
                                                </TextBox.Text>
                                            </TextBox>
                                        </StackPanel>

                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Mid Threshold (m)" Style="{StaticResource SettingsLabel}"/>
                                            <TextBox Style="{StaticResource SettingsTextBox}">
                                                <TextBox.Text>
                                                    <Binding Path="RadarProximityMidThreshold" UpdateSourceTrigger="PropertyChanged">
                                                        <Binding.ValidationRules>
                                                            <validation:DoubleRangeValidationRule Min="1" Max="200"/>
                                                        </Binding.ValidationRules>
                                                    </Binding>
                                                </TextBox.Text>
                                            </TextBox>
                                        </StackPanel>
                                    </StackPanel>

                                    <TextBlock Text="ALERTS" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>

                                    <CheckBox Content="Show Blind Spot Indicators" IsChecked="{Binding RadarShowBlindSpotIndicators}" Style="{StaticResource SettingsCheckBox}"/>
                                    <CheckBox Content="Enable Sound Alerts" IsChecked="{Binding RadarEnableSoundAlerts}" Style="{StaticResource SettingsCheckBox}"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Alert Cooldown (ms)" Style="{StaticResource SettingsLabel}"/>
                                        <TextBox Style="{StaticResource SettingsTextBox}">
                                            <TextBox.Text>
                                                <Binding Path="RadarAlertCooldownMs" UpdateSourceTrigger="PropertyChanged">
                                                    <Binding.ValidationRules>
                                                        <validation:IntRangeValidationRule Min="100" Max="10000"/>
                                                    </Binding.ValidationRules>
                                                </Binding>
                                            </TextBox.Text>
                                        </TextBox>
                                    </StackPanel>
                                </StackPanel>

                                <!-- Position Section (shared) -->
                                <TextBlock Text="POSITION" FontSize="11" FontWeight="Bold" Foreground="{StaticResource RO.MutedBrush}" Margin="0,16,0,8"/>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Overlay Position" Style="{StaticResource SettingsLabel}"/>
                                    <TextBlock Text="{Binding OverlayPositionText}" Foreground="{StaticResource RO.ForegroundBrush}" FontSize="12" VerticalAlignment="Center"/>
                                </StackPanel>
                            </StackPanel>
                        </ScrollViewer>
                    </Border>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Bottom Action Bar -->
        <Border Grid.Row="1" Background="{StaticResource RO.SurfaceBrush}"
                BorderBrush="{StaticResource RO.BorderBrush}" BorderThickness="0,1,0,0"
                Padding="16,10">
            <DockPanel>
                <Button DockPanel.Dock="Right"
                        Content="Start Layout"
                        Command="{Binding StartLayoutCommand}"
                        Style="{StaticResource PurpleRoundedButtonStyle}"
                        AutomationProperties.AutomationId="StartLayoutButton"
                        Margin="8,0,0,0"/>
                <Button DockPanel.Dock="Left"
                        Content="{Binding SetupModeButtonText}"
                        Command="{Binding ToggleSetupModeCommand}"
                        Style="{StaticResource PurpleRoundedButtonStyle}"
                        AutomationProperties.AutomationId="ToggleSetupModeButton"/>
                <Border/>
            </DockPanel>
        </Border>
    </Grid>
</Window>
