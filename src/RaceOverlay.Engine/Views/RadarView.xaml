<UserControl x:Class="RaceOverlay.Engine.Views.RadarView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:conv="clr-namespace:RaceOverlay.Engine.Converters"
             mc:Ignorable="d"
             d:DesignHeight="300" d:DesignWidth="200"
             Background="Transparent">

    <UserControl.Resources>
        <conv:StringToSolidColorBrushConverter x:Key="ColorConv"/>
        <conv:RadarXConverter x:Key="RadarXConverter"/>
        <conv:RadarYConverter x:Key="RadarYConverter"/>
    </UserControl.Resources>

    <Border BorderBrush="{StaticResource RO.BorderBrush}" BorderThickness="1" Background="{StaticResource RO.BackgroundBrush}" CornerRadius="8">
        <Grid Margin="10">
            <!-- Radar Grid lines (longitudinal) -->
            <Canvas IsHitTestVisible="False">
                <Line X1="0" Y1="50" X2="180" Y2="50" Stroke="{StaticResource RO.BorderBrush}" StrokeThickness="0.5" StrokeDashArray="4 2"/>
                <Line X1="0" Y1="100" X2="180" Y2="100" Stroke="{StaticResource RO.BorderBrush}" StrokeThickness="0.5" StrokeDashArray="4 2"/>
                <Line X1="0" Y1="150" X2="180" Y2="150" Stroke="{StaticResource RO.BorderBrush}" StrokeThickness="1"/> <!-- Center line (player) -->
                <Line X1="0" Y1="200" X2="180" Y2="200" Stroke="{StaticResource RO.BorderBrush}" StrokeThickness="0.5" StrokeDashArray="4 2"/>
                <Line X1="0" Y1="250" X2="180" Y2="250" Stroke="{StaticResource RO.BorderBrush}" StrokeThickness="0.5" StrokeDashArray="4 2"/>
                
                <!-- Center vertical line -->
                <Line X1="90" Y1="0" X2="90" Y2="300" Stroke="{StaticResource RO.BorderBrush}" StrokeThickness="0.5" StrokeDashArray="2 2"/>
            </Canvas>

            <ItemsControl ItemsSource="{Binding Cars}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas Width="180" Height="280"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <!-- Map longitudinal offset to Y and lateral offset to X -->
                        <!-- 150 is the vertical center (player position) -->
                        <!-- 90 is the horizontal center -->
                        <!-- Scale: 150 pixels = RangeMeters meters -->
                        <Setter Property="Canvas.Left">
                            <Setter.Value>
                                <MultiBinding Converter="{StaticResource RadarXConverter}">
                                    <Binding Path="LateralOffset"/>
                                    <Binding Path="ActualWidth" RelativeSource="{RelativeSource AncestorType=Canvas}"/>
                                </MultiBinding>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Canvas.Top">
                            <Setter.Value>
                                <MultiBinding Converter="{StaticResource RadarYConverter}">
                                    <Binding Path="LongitudinalOffset"/>
                                    <Binding Path="DataContext.RangeMeters" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                    <Binding Path="ActualHeight" RelativeSource="{RelativeSource AncestorType=Canvas}"/>
                                </MultiBinding>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ItemsControl.ItemContainerStyle>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Rectangle Width="20" Height="35" 
                                   Fill="{Binding Color, Converter={StaticResource ColorConv}}" 
                                   RadiusX="3" RadiusY="3"
                                   Stroke="Black" StrokeThickness="1">
                            <Rectangle.ToolTip>
                                <ToolTip Content="{Binding DriverName}"/>
                            </Rectangle.ToolTip>
                        </Rectangle>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>
    </Border>
</UserControl>
